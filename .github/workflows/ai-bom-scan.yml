name: AI-BOM Scan (PR)

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-bom:
    runs-on: ubuntu-latest

    env:
      AIBOM_JSON: aibom.json
      SUMMARY_JSON: aibom-summary.json

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # Use the official AI-BOM GitHub Action (faster than pip install)
      - name: Run AI-BOM scan (AIBOM JSON)
        id: scan
        uses: trusera/ai-bom@v3
        continue-on-error: true
        with:
          path: "."
          format: "aibom"
          output: "${{ env.AIBOM_JSON }}"
          # Native policy gate (requested by reviewer)
          fail-on: "high"

      # Python only for building summary + PR comment
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Build summary (pass/fail + counts)
        run: |
          python - <<'PY'
          import json, os

          aibom_path = os.environ["AIBOM_JSON"]
          out_path = os.environ["SUMMARY_JSON"]
          scan_status = os.environ.get("SCAN_STATUS", "PASS")

          components = []

          try:
            with open(aibom_path, "r", encoding="utf-8") as f:
              data = json.load(f)

            # Best-effort component extraction across likely schemas
            if isinstance(data, dict):
              components = data.get("components") or data.get("aiComponents") or []
              if not isinstance(components, list):
                components = []
              if not components and isinstance(data.get("results"), dict):
                components = data["results"].get("components") or data["results"].get("aiComponents") or []
                if not isinstance(components, list):
                  components = []

          except FileNotFoundError:
            # Scan step may fail before producing output.
            components = []

          summary = {
            "status": scan_status,
            "components_found": len(components),
            "policy_gate": "fail-on: high",
            "artifact_generated": os.path.exists(aibom_path),
          }

          with open(out_path, "w", encoding="utf-8") as f:
            json.dump(summary, f, indent=2)

          print(json.dumps(summary, indent=2))
          PY
        env:
          SCAN_STATUS: ${{ steps.scan.outcome == 'success' && 'PASS' || 'FAIL' }}

      - name: Upload AIBOM JSON artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ai-bom-results
          path: |
            ${{ env.AIBOM_JSON }}
            ${{ env.SUMMARY_JSON }}
          if-no-files-found: warn

      - name: Create PR comment body
        id: comment
        run: |
          python - <<'PY'
          import json, os

          with open(os.environ["SUMMARY_JSON"], "r", encoding="utf-8") as f:
            s = json.load(f)

          status = s["status"]
          emoji = "✅" if status == "PASS" else "❌"

          if s.get("artifact_generated"):
            artifact_note = f"Artifact uploaded: `{os.environ['AIBOM_JSON']}`"
          else:
            artifact_note = "Artifact not generated (scan may have failed before producing output)."

          body = f"""### {emoji} AI-BOM Scan Result: **{status}**

          - **Components found:** {s["components_found"]}
          - **Policy gate:** {s["policy_gate"]}

          {artifact_note}
          """

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write("body<<EOF\n")
            f.write(body)
            f.write("\nEOF\n")
          PY

      - name: Post PR comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.comment.outputs.body }}
          edit-mode: replace

      # Enforce failure after comment + artifacts (so reviewers still see output)
      - name: Fail if policy gate failed
        if: steps.scan.outcome != 'success'
        run: |
          echo "AI-BOM policy gate failed (fail-on: high)."
          exit 1
          