name: Auto Release

on:
  push:
    branches:
      - main
    tags-ignore:
      - "**"

permissions:
  contents: write
  id-token: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    if: "!startsWith(github.event.head_commit.message, 'chore(release):')"
    outputs:
      ai_bom: ${{ steps.changes.outputs.ai_bom }}
      agent_sdk: ${{ steps.changes.outputs.agent_sdk }}
      sdk_js: ${{ steps.changes.outputs.sdk_js }}
      sdk_go: ${{ steps.changes.outputs.sdk_go }}
      n8n_node: ${{ steps.changes.outputs.n8n_node }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changed packages
        id: changes
        run: |
          set -euo pipefail

          # Helper: check if any files changed in a directory since a tag
          has_changes() {
            local TAG_PATTERN="$1"
            local DIR="$2"
            local LATEST_TAG=$(git tag --list "${TAG_PATTERN}" --sort=-v:refname | head -n1)
            if [ -z "$LATEST_TAG" ]; then
              # No tag exists — check if directory has any files
              if [ -d "$DIR" ]; then echo "true"; else echo "false"; fi
              return
            fi
            local CHANGED=$(git diff --name-only "${LATEST_TAG}..HEAD" -- "$DIR" | head -1)
            if [ -n "$CHANGED" ]; then echo "true"; else echo "false"; fi
          }

          echo "ai_bom=$(has_changes 'v[0-9]*' 'src/')" >> "$GITHUB_OUTPUT"
          echo "agent_sdk=$(has_changes 'sdk-v*' 'trusera-agent-sdk/')" >> "$GITHUB_OUTPUT"
          echo "sdk_js=$(has_changes 'js-v*' 'trusera-sdk-js/')" >> "$GITHUB_OUTPUT"
          echo "sdk_go=$(has_changes 'go-v*' 'trusera-sdk-go/')" >> "$GITHUB_OUTPUT"
          echo "n8n_node=$(has_changes 'n8n-v*' 'n8n-node/')" >> "$GITHUB_OUTPUT"

          echo "=== Change detection ==="
          echo "ai_bom=$(has_changes 'v[0-9]*' 'src/')"
          echo "agent_sdk=$(has_changes 'sdk-v*' 'trusera-agent-sdk/')"
          echo "sdk_js=$(has_changes 'js-v*' 'trusera-sdk-js/')"
          echo "sdk_go=$(has_changes 'go-v*' 'trusera-sdk-go/')"
          echo "n8n_node=$(has_changes 'n8n-v*' 'n8n-node/')"

  # ─── ai-bom → PyPI (trusted publishing) ───
  release-ai-bom:
    needs: detect-changes
    if: needs.detect-changes.outputs.ai_bom == 'true'
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN }}

      - name: Bump version
        id: bump
        run: |
          set -euo pipefail
          LATEST_TAG=$(git tag --list 'v[0-9]*' --sort=-v:refname | head -n1)
          [ -z "$LATEST_TAG" ] && LATEST_TAG="v0.0.0"
          COMMITS=$(git log --pretty=format:"%s" "${LATEST_TAG}..HEAD" -- src/ pyproject.toml)
          [ -z "$COMMITS" ] && { echo "skip=true" >> "$GITHUB_OUTPUT"; exit 0; }

          VERSION="${LATEST_TAG#v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          HAS_BREAKING=false; HAS_FEAT=false; HAS_FIX=false
          while IFS= read -r msg; do
            echo "$msg" | grep -qi "BREAKING CHANGE" && HAS_BREAKING=true
            echo "$msg" | grep -qE "^[a-z]+(\(.+\))?!:" && HAS_BREAKING=true
            echo "$msg" | grep -qE "^feat(\(.+\))?[!]?:" && ! echo "$msg" | grep -qE "^feat\((ci|deps|build|chore)\)" && HAS_FEAT=true
            echo "$msg" | grep -qE "^fix(\(.+\))?[!]?:" && ! echo "$msg" | grep -qE "^fix\((ci|deps|build|chore)\)" && HAS_FIX=true
          done <<< "$COMMITS"

          if [ "$HAS_BREAKING" = true ]; then MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0
          elif [ "$HAS_FEAT" = true ]; then MINOR=$((MINOR+1)); PATCH=0
          elif [ "$HAS_FIX" = true ]; then PATCH=$((PATCH+1))
          else echo "skip=true" >> "$GITHUB_OUTPUT"; exit 0; fi

          NEW="${MAJOR}.${MINOR}.${PATCH}"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "version=$NEW" >> "$GITHUB_OUTPUT"
          echo "ai-bom: $VERSION → $NEW"

      - name: Update, commit, tag, push
        if: steps.bump.outputs.skip != 'true'
        run: |
          V="${{ steps.bump.outputs.version }}"
          sed -i "s/^__version__ = \".*\"/__version__ = \"${V}\"/" src/ai_bom/__init__.py
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add src/ai_bom/__init__.py
          git commit -m "chore(release): ai-bom v${V} [skip ci]"
          git tag "v${V}"
          git push origin main
          git push origin "v${V}"

      - uses: actions/setup-python@v6
        if: steps.bump.outputs.skip != 'true'
        with: { python-version: "3.12" }

      - name: Build & publish
        if: steps.bump.outputs.skip != 'true'
        run: pip install build && python -m build

      - name: Publish to PyPI
        if: steps.bump.outputs.skip != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1

  # ─── trusera-sdk (Python Agent SDK) → PyPI ───
  release-agent-sdk:
    needs: detect-changes
    if: needs.detect-changes.outputs.agent_sdk == 'true'
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN }}

      - name: Bump version
        id: bump
        run: |
          set -euo pipefail
          LATEST_TAG=$(git tag --list 'sdk-v*' --sort=-v:refname | head -n1)
          [ -z "$LATEST_TAG" ] && LATEST_TAG="sdk-v0.0.0"
          COMMITS=$(git log --pretty=format:"%s" "${LATEST_TAG}..HEAD" -- trusera-agent-sdk/)
          [ -z "$COMMITS" ] && { echo "skip=true" >> "$GITHUB_OUTPUT"; exit 0; }

          VERSION="${LATEST_TAG#sdk-v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          HAS_BREAKING=false; HAS_FEAT=false; HAS_FIX=false
          while IFS= read -r msg; do
            echo "$msg" | grep -qi "BREAKING CHANGE" && HAS_BREAKING=true
            echo "$msg" | grep -qE "^feat(\(.+\))?[!]?:" && ! echo "$msg" | grep -qE "^feat\((ci|deps|build|chore)\)" && HAS_FEAT=true
            echo "$msg" | grep -qE "^fix(\(.+\))?[!]?:" && ! echo "$msg" | grep -qE "^fix\((ci|deps|build|chore)\)" && HAS_FIX=true
          done <<< "$COMMITS"

          if [ "$HAS_BREAKING" = true ]; then MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0
          elif [ "$HAS_FEAT" = true ]; then MINOR=$((MINOR+1)); PATCH=0
          elif [ "$HAS_FIX" = true ]; then PATCH=$((PATCH+1))
          else echo "skip=true" >> "$GITHUB_OUTPUT"; exit 0; fi

          NEW="${MAJOR}.${MINOR}.${PATCH}"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "version=$NEW" >> "$GITHUB_OUTPUT"
          echo "agent-sdk: $VERSION → $NEW"

      - name: Update, commit, tag, push
        if: steps.bump.outputs.skip != 'true'
        run: |
          V="${{ steps.bump.outputs.version }}"
          sed -i "s/^__version__ = \".*\"/__version__ = \"${V}\"/" trusera-agent-sdk/trusera_sdk/__init__.py
          sed -i "s/^version = \".*\"/version = \"${V}\"/" trusera-agent-sdk/pyproject.toml
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add trusera-agent-sdk/trusera_sdk/__init__.py trusera-agent-sdk/pyproject.toml
          git commit -m "chore(release): trusera-sdk v${V} [skip ci]"
          git tag "sdk-v${V}"
          git push origin main
          git push origin "sdk-v${V}"

      - uses: actions/setup-python@v6
        if: steps.bump.outputs.skip != 'true'
        with: { python-version: "3.12" }

      - name: Build & publish
        if: steps.bump.outputs.skip != 'true'
        run: cd trusera-agent-sdk && pip install build && python -m build

      - name: Publish to PyPI
        if: steps.bump.outputs.skip != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: trusera-agent-sdk/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}

  # ─── trusera-sdk (JS) → npm ───
  release-sdk-js:
    needs: detect-changes
    if: needs.detect-changes.outputs.sdk_js == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN }}

      - name: Bump version
        id: bump
        run: |
          set -euo pipefail
          LATEST_TAG=$(git tag --list 'js-v*' --sort=-v:refname | head -n1)
          [ -z "$LATEST_TAG" ] && LATEST_TAG="js-v0.0.0"
          COMMITS=$(git log --pretty=format:"%s" "${LATEST_TAG}..HEAD" -- trusera-sdk-js/)
          [ -z "$COMMITS" ] && { echo "skip=true" >> "$GITHUB_OUTPUT"; exit 0; }

          VERSION="${LATEST_TAG#js-v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          HAS_BREAKING=false; HAS_FEAT=false; HAS_FIX=false
          while IFS= read -r msg; do
            echo "$msg" | grep -qi "BREAKING CHANGE" && HAS_BREAKING=true
            echo "$msg" | grep -qE "^feat(\(.+\))?[!]?:" && ! echo "$msg" | grep -qE "^feat\((ci|deps|build|chore)\)" && HAS_FEAT=true
            echo "$msg" | grep -qE "^fix(\(.+\))?[!]?:" && ! echo "$msg" | grep -qE "^fix\((ci|deps|build|chore)\)" && HAS_FIX=true
          done <<< "$COMMITS"

          if [ "$HAS_BREAKING" = true ]; then MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0
          elif [ "$HAS_FEAT" = true ]; then MINOR=$((MINOR+1)); PATCH=0
          elif [ "$HAS_FIX" = true ]; then PATCH=$((PATCH+1))
          else echo "skip=true" >> "$GITHUB_OUTPUT"; exit 0; fi

          NEW="${MAJOR}.${MINOR}.${PATCH}"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "version=$NEW" >> "$GITHUB_OUTPUT"
          echo "sdk-js: $VERSION → $NEW"

      - uses: actions/setup-node@v6
        if: steps.bump.outputs.skip != 'true'
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Update, commit, tag, push
        if: steps.bump.outputs.skip != 'true'
        run: |
          V="${{ steps.bump.outputs.version }}"
          cd trusera-sdk-js && npm version "$V" --no-git-tag-version && cd ..
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add trusera-sdk-js/package.json
          git commit -m "chore(release): trusera-sdk-js v${V} [skip ci]"
          git tag "js-v${V}"
          git push origin main
          git push origin "js-v${V}"

      - name: Build & publish to npm
        if: steps.bump.outputs.skip != 'true'
        run: cd trusera-sdk-js && npm ci && npm run build && npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM }}

  # ─── trusera-sdk-go → Go modules (tag only) ───
  release-sdk-go:
    needs: detect-changes
    if: needs.detect-changes.outputs.sdk_go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN }}

      - name: Bump version
        id: bump
        run: |
          set -euo pipefail
          LATEST_TAG=$(git tag --list 'go-v*' --sort=-v:refname | head -n1)
          [ -z "$LATEST_TAG" ] && LATEST_TAG="go-v0.0.0"
          COMMITS=$(git log --pretty=format:"%s" "${LATEST_TAG}..HEAD" -- trusera-sdk-go/)
          [ -z "$COMMITS" ] && { echo "skip=true" >> "$GITHUB_OUTPUT"; exit 0; }

          VERSION="${LATEST_TAG#go-v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          HAS_BREAKING=false; HAS_FEAT=false; HAS_FIX=false
          while IFS= read -r msg; do
            echo "$msg" | grep -qi "BREAKING CHANGE" && HAS_BREAKING=true
            echo "$msg" | grep -qE "^feat(\(.+\))?[!]?:" && ! echo "$msg" | grep -qE "^feat\((ci|deps|build|chore)\)" && HAS_FEAT=true
            echo "$msg" | grep -qE "^fix(\(.+\))?[!]?:" && ! echo "$msg" | grep -qE "^fix\((ci|deps|build|chore)\)" && HAS_FIX=true
          done <<< "$COMMITS"

          if [ "$HAS_BREAKING" = true ]; then MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0
          elif [ "$HAS_FEAT" = true ]; then MINOR=$((MINOR+1)); PATCH=0
          elif [ "$HAS_FIX" = true ]; then PATCH=$((PATCH+1))
          else echo "skip=true" >> "$GITHUB_OUTPUT"; exit 0; fi

          NEW="${MAJOR}.${MINOR}.${PATCH}"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "version=$NEW" >> "$GITHUB_OUTPUT"
          echo "sdk-go: $VERSION → $NEW"

      - name: Tag and push
        if: steps.bump.outputs.skip != 'true'
        run: |
          V="${{ steps.bump.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Go modules use the subdir path as tag prefix
          git tag "trusera-sdk-go/v${V}"
          git push origin "trusera-sdk-go/v${V}"
          echo "Tagged trusera-sdk-go/v${V} — available via: go get github.com/Trusera/ai-bom/trusera-sdk-go@v${V}"

  # ─── n8n-nodes-trusera → npm ───
  release-n8n-node:
    needs: detect-changes
    if: needs.detect-changes.outputs.n8n_node == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN }}

      - name: Bump version
        id: bump
        run: |
          set -euo pipefail
          LATEST_TAG=$(git tag --list 'n8n-v*' --sort=-v:refname | head -n1)
          [ -z "$LATEST_TAG" ] && LATEST_TAG="n8n-v0.0.0"
          COMMITS=$(git log --pretty=format:"%s" "${LATEST_TAG}..HEAD" -- n8n-node/)
          [ -z "$COMMITS" ] && { echo "skip=true" >> "$GITHUB_OUTPUT"; exit 0; }

          VERSION="${LATEST_TAG#n8n-v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          HAS_BREAKING=false; HAS_FEAT=false; HAS_FIX=false
          while IFS= read -r msg; do
            echo "$msg" | grep -qi "BREAKING CHANGE" && HAS_BREAKING=true
            echo "$msg" | grep -qE "^feat(\(.+\))?[!]?:" && ! echo "$msg" | grep -qE "^feat\((ci|deps|build|chore)\)" && HAS_FEAT=true
            echo "$msg" | grep -qE "^fix(\(.+\))?[!]?:" && ! echo "$msg" | grep -qE "^fix\((ci|deps|build|chore)\)" && HAS_FIX=true
          done <<< "$COMMITS"

          if [ "$HAS_BREAKING" = true ]; then MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0
          elif [ "$HAS_FEAT" = true ]; then MINOR=$((MINOR+1)); PATCH=0
          elif [ "$HAS_FIX" = true ]; then PATCH=$((PATCH+1))
          else echo "skip=true" >> "$GITHUB_OUTPUT"; exit 0; fi

          NEW="${MAJOR}.${MINOR}.${PATCH}"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "version=$NEW" >> "$GITHUB_OUTPUT"
          echo "n8n-node: $VERSION → $NEW"

      - uses: actions/setup-node@v6
        if: steps.bump.outputs.skip != 'true'
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Update, commit, tag, push
        if: steps.bump.outputs.skip != 'true'
        run: |
          V="${{ steps.bump.outputs.version }}"
          cd n8n-node && npm version "$V" --no-git-tag-version && cd ..
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add n8n-node/package.json
          git commit -m "chore(release): n8n-nodes-trusera v${V} [skip ci]"
          git tag "n8n-v${V}"
          git push origin main
          git push origin "n8n-v${V}"

      - name: Build & publish to npm
        if: steps.bump.outputs.skip != 'true'
        run: cd n8n-node && npm ci && npm run build && npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM }}
